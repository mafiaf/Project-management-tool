<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="top-right-icons">
        <!-- Icon for Pending Invitations -->
        <div class="icon-container" data-url="{{ url_for('main.view_invitations') }}">
            <img src="{{ url_for('static', filename='icons/invitation-icon.png') }}" alt="Pending Invitations" title="Pending Invitations">
        </div>
        <!-- Icon for Adding a New Task -->
        <div class="icon-container" data-url="{{ url_for('main.add_task') }}">
            <img src="{{ url_for('static', filename='icons/add-task-icon.png') }}" alt="Add New Task" title="Add New Task">
        </div>
        <!-- Icon for Logout -->
        <div class="icon-container" data-url="{{ url_for('main.logout') }}">
            <img src="{{ url_for('static', filename='icons/logout-icon.png') }}" alt="Logout" title="Logout">
        </div>
    </div>
        
    <h1>Welcome to your dashboard!</h1>

<!-- Grid container for category navigation -->
<div class="categories-grid">
    {% if not categories %}
        <p class="no-categories-message">You have no categories yet. Click the add button to create one.</p>
    {% endif %}
    <div class="grid-container">
        {% if categories %}
        {% for category in categories %}
        <div class="category-card" data-category-id="{{ category.id }}" style="position: relative; background-color: {{ category.color | safe }};">
            <!-- Shared Badge (only if shared) -->
            {% if category.shared %}
                <div class="shared-badge">&#x1F4E4;</div>
            {% endif %}

            <!-- Three Dots Menu for additional actions -->
            <div class="menu-icon" onclick="toggleMenu('{{ category.id }}')">&#x22EE;</div>

            <!-- Dropdown Menu for actions like Edit or Delete -->
            <div class="menu-options" id="menu-{{ category.id }}" style="display: none;">
                <div class="menu-item">
                    <a href="#" onclick="openEditCategoryModal(event, '{{ category.id }}')">
                        <span class="edit-icon">&#x270E;</span> Edit
                    </a>
                </div>
                <div class="menu-item">
                    <a href="#" onclick="deleteCategory(event, '{{ category.id }}')">
                        <span class="delete-icon">&#x1F5D1;</span> Delete
                    </a>
                </div>
            </div>

            <!-- Category Card Content -->
            <h3>{{ category.name }}</h3>
            <p class="category-description">{{ category.description }}</p> <!-- Added category description -->
            <p>Top 5 Tasks:</p>
            <ul>
                {% for task in category.tasks[:5] %}
                    <li>{{ task.title }}</li>
                {% endfor %}
            </ul>
            <p>Tasks Completed: {{ category.completed_tasks }} / {{ category.task_count }}</p> <!-- Task Count Summary -->
            <button class="add-task-btn" data-category-id="{{ category.id }}">Add Task</button>
            <button class="mark-all-btn" data-category-id="{{ category.id }}">Mark All as Completed</button>
        </div>
        {% endfor %}        
        {% endif %}
    </div>
</div>

<!-- Button to add a new category -->
<div class="add-category-card" onclick="document.getElementById('categoryModal').style.display='block';">
    <h2>+</h2>
</div>

<!-- Modal for creating a new category -->
<div id="categoryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h2>Create New Category</h2>
        <form id="categoryForm" method="POST" action="{{ url_for('main.add_category') }}">
            <label for="categoryName">Category Name:</label>
            <input type="text" id="categoryName" name="categoryName" required>
            
            <label for="categoryColor">Category Color:</label>
            <input type="color" id="categoryColor" name="categoryColor" value="#007bff">
            <button type="button" id="confirmColorBtn" class="btn">Confirm Color</button>
            
            <label for="categoryDescription">Category Description:</label>
            <textarea id="categoryDescription" name="categoryDescription" rows="3"></textarea>
            
            <button type="submit" class="btn">Create Category</button>
        </form>
    </div>
</div>

<!-- Modal for editing a category -->
<div id="editCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn" id="closeEditModal">&times;</span>
        <h2>Edit Category</h2>
        <form id="editCategoryForm" onsubmit="submitEditCategory(event)">
            <input type="hidden" id="editCategoryId" name="categoryId">
            <label for="editCategoryName">Category Name:</label>
            <input type="text" id="editCategoryName" name="categoryName" required>
            
            <label for="editCategoryDescription">Category Description:</label>
            <textarea id="editCategoryDescription" name="categoryDescription" rows="3"></textarea>

            <label for="editCategoryColor">Category Color:</label>
            <input type="color" id="editCategoryColor" name="categoryColor">

            <button type="submit" class="btn">Save Changes</button>
        </form>
    </div>
</div>

<!-- Display tasks grouped by selected category -->
<h2>Tasks for Selected Category:</h2>
<ul>
    {% if owned_tasks %}
        <h3>Owned Tasks:</h3>
        {% for task in owned_tasks %}
            <li>
                <a href="{{ url_for('main.view_task', task_id=task.id) }}">
                    <strong>{{ task.title }}</strong>
                </a>: {{ task.description }}
                <br>
                <!-- Links to edit, delete, share, and view comments on tasks -->
                <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="btn">Edit</a>
                <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
                <a href="{{ url_for('main.share_task', task_id=task.id) }}" class="btn btn-secondary">Share Task</a>
                <a href="{{ url_for('main.task_comments', task_id=task.id) }}" class="btn btn-secondary">View Comments</a>
            </li>
        {% endfor %}
    {% else %}
        <p>No owned tasks found in this category.</p>
    {% endif %}
</ul>


<!-- Display shared tasks -->
<h2>Shared Tasks:</h2>
<ul>
    {% if shared_tasks %}
        {% for task, role in shared_tasks %}
            <li>
                <a href="{{ url_for('main.view_task', task_id=task.id) }}">
                    <strong>{{ task.title }}</strong>
                </a>: {{ task.description }} (Role: {{ role }})
                <br>
                <!-- Links to view and interact with shared tasks (editor/viewer may have limited actions) -->
                <a href="{{ url_for('main.task_comments', task_id=task.id) }}" class="btn btn-secondary">View Comments</a>

                <!-- Only show edit button if the user's role is Editor or Admin -->
                {% if role in ['Editor', 'Admin'] %}
                    <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="btn btn-secondary">Edit Task</a>
                {% endif %}
            </li>
        {% endfor %}
    {% else %}
        <p>No shared tasks found.</p>
    {% endif %}
</ul>


<!-- Display uncategorized tasks -->
<h2>Uncategorized Tasks:</h2>
<ul>
    {% if uncategorized_tasks %}
        {% for task in uncategorized_tasks %}
            <li>
                <a href="{{ url_for('main.view_task', task_id=task.id) }}">
                    <strong>{{ task.title }}</strong>
                </a>: {{ task.description }}
                <br>
                <!-- Links to edit, delete, share, and view comments on tasks -->
                <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="btn">Edit</a>
                <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
                <a href="{{ url_for('main.share_task', task_id=task.id) }}" class="btn btn-secondary">Share Task</a>
                <a href="{{ url_for('main.task_comments', task_id=task.id) }}" class="btn btn-secondary">View Comments</a>
            </li>
        {% endfor %}
    {% else %}
        <p>No uncategorized tasks found.</p>
    {% endif %}
</ul>


<!-- Links -->
<a href="{{ url_for('main.add_task') }}" class="btn">Add New Task</a><br><br>
<a href="{{ url_for('main.logout') }}" class="btn btn-secondary">Logout</a>

<!-- Scripts -->
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>
