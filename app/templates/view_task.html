<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Task</title>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
    <!-- FullCalendar CSS -->
    <link href="{{ url_for('static', filename='@fullcalendar/core/index.global.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='@fullcalendar/daygrid/index.global.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='@fullcalendar/timegrid/index.global.min.css') }}" rel="stylesheet">

    <!-- Custom Calendar CSS -->
    <link href="{{ url_for('static', filename='css/custom-calendar.css') }}" rel="stylesheet">
</head>
<body>
    {% extends "base.html" %} 
    {% block content %}
    <input type="hidden" id="taskId" value="{{ task.id }}">
    <!-- Task Details -->
    <h1>{{ task.title }}</h1>
    <p><strong>Description:</strong> {{ task.description }}</p>
    <p><strong>Category:</strong> {{ task.category.name if task.category else 'Uncategorized' }}</p>
    
    <p><strong>Assigned Users:</strong></p>
    <ul>
        {% for user in task.users %}
            <li>{{ user.username }} (Role: {{ user.role }})</li>
        {% endfor %}
    </ul>

    <a href="{{ url_for('main.manage_task_users', task_id=task.id) }}" class="btn btn-secondary">Manage Users</a>
    <a href="{{ url_for('main.edit_task', task_id=task.id) }}" class="btn">Edit Task</a>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>

    <!-- Calendar Container for Full Overview -->
    <h2>Task Schedule Overview</h2>
    <div id="calendar" style="max-width: 1100px; margin: 40px auto;"></div>

    <!-- FullCalendar JS -->
    <script src="{{ url_for('static', filename='@fullcalendar/core/index.global.min.js') }}"></script>
    <script src="{{ url_for('static', filename='@fullcalendar/daygrid/index.global.min.js') }}"></script>
    <script src="{{ url_for('static', filename='@fullcalendar/timegrid/index.global.min.js') }}"></script>
    <script src="{{ url_for('static', filename='@fullcalendar/interaction/index.global.min.js') }}"></script>

    <!-- JavaScript to Render the Calendar -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var taskId = document.getElementById('taskId').value;  // Retrieve task ID from hidden input
    
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                firstDay: 1,  // Start the week from Monday
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: false,
                selectable: false,
                events: function(fetchInfo, successCallback, failureCallback) {
                    // Fetch events related to the current task from the backend
                    fetch(`/api/tasks?task_id=${taskId}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Fetched events data:", data);  // Log the fetched events data
                            successCallback(data);
                        })
                        .catch(error => {
                            console.error("Failed to fetch events:", error);  // Log errors if fetch fails
                            failureCallback(error);
                        });
                },
                height: 'auto'  // Adjust calendar height to fit content
            });
    
            calendar.render();
        });
    </script>    
    {% endblock %}
    
</body>
</html>
